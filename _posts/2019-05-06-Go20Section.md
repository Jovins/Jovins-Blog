---
layout: post
title: "20-Go语言并发编程"
date: 2019-05-06 20:31:00.000000000 +09:00
categories: [Go]
tags: [Go]
---

## 并发编程基本概念

- 学习并发编程之前我们需要脑补几个基础知识和思考一个问题
  - 什么是串行?
  - 什么是并行?
  - 什么是并发?
  - 什么是程序?
  - 什么是进程?
  - 什么是线程?
  - 什么是协程?

- 什么是串行?

  - 串行就是按顺序执行, 就好比银行只有1个窗口, 有3个人要办事, 那么必须排队, 只有前面的人办完走人, 才能轮到你
  - 在计算机中, **同一时刻, 只能有一条指令, 在一个CPU上执行, 后面的指令必须等到前面指令执行完才能执行**, 就是串行

  ![](/assets/images/2019Go/go-go20section-01.png)

- 什么是并行?

  - 并行就是同时执行, 就好比银行有3个窗口, 有3个人要办事, 只需要到空窗口即可立即办事.
  - 在计算机中, **同一时刻, 有多条指令, 在多个CPU上执行**, 就是并行
  - 从以上分析不难看出, 并行的速度优于串行

  ![](/assets/images/2019Go/go-go20section-02.png)

- 什么是并发?

  - 并发是伪并行, 就好比银行只有1个窗口, 有3个人要办事, 那么没轮到后面的人时, 后面的人可以用拖鞋先排队, 去吃个早餐,买个东西啥的, 感觉差不多要到自己时再回来办事
  - 在计算机中, **同一时刻, 只能有一条指令, 在一个CPU上执行, 但是CPU会快速的在多条指令之间轮询执行**就是并发
  - 并行和并发的区别就好比古代的三妻四妾(名正言顺, 光明正大)和现代三妻四妾(抽空幽会, 小三小四)

  ![](/assets/images/2019Go/go-go20section-03.png)


- 总结:
  - 多线程程序在单核上运行, 就是并发
  - 多线程程序在多核上运行,就是并行

- 什么是程序?

  - `程序`是指编译之后存储在磁盘上的一个`二进制文件`, 会占用磁盘空间, 但不会占用系统资源

- 什么是进程?

  - `进程`是指`程序`在操作系统中的一次执行过程, 是系统进行资源分配和调度的基本单位
  - 例如:
    - 启动记事本这个程序, 在系统中就会创建一个记事本进程
    - 再次启动记事本这个程序, 又会在系统中创建一个记事本进程
  - 程序和进程的关系就好比剧本和演出的关系
    - 剧本对应程序, 演出对应进程. 同一个剧本可以在多个舞台同时演出互不影响, 同一个程序可以在系统中开启多个进程互不影响
  - 所以程序和进程的关系是1:N, 所以多个进程的空间是独立的

- 什么是线程?

  - 线程是指进程中的一个执行实例, 是程序执行的最小单元, 它是比进程更小的能独立运行的基本单位
  - 一个进程中至少有一个线程, 这个线程我们称之为`主线程`
  - 一个进程中除了`主线程`以外, 我们还可以创建和销毁多个线程
  - 例如:
    - 启动迅雷这个程序, 系统会创建一个`迅雷进程`, 并且默认会有一个`主线程`, 用于执行迅雷默认的业务逻辑
    - 当我们利用迅雷下载`多个任务`的时候, 会发现多个任务都在`同时下载`, 此时为了能够`同时执行`下载操作, 迅雷就会创建多个线程, 将不同的下载任务放到不同的线程中执行

  ![](/assets/images/2019Go/go-go20section-04.png)

- 什么是协程?

  - 协程是一种用户态的轻量级线程，又称微线程，英文名Coroutine
  - 与传统的系统级别进程和线程相比, 协程最大的优势在于"轻量级". 可以轻松创建上万个不会导致系统资源衰竭. 而线程和进程通常很难超过1万个.这也是协程称之为"轻量级线程"的原因
  - 一个线程中可以有任意多个协程, 但`某一时刻只能有一个协程在运行`, 多个协程分享所在线程分配到的计算机资源

  ![](/assets/images/2019Go/go-go20section-05.png)


- 在协程中, 调用一个任务就像调用一个函数一样, 消耗系统资源极少, 但能达到进程、线程相同的并发效果

## Go并发

- Go在语言级别支持`协程`(多数语言在语法层面并不直接支持协程), 叫做goroutine.
- 人们把Go语言称之为21世纪的C语言. 第一是因为Go语言设计简单, 第二是因为21世纪最重要的就是并行程序设计.而Go从语言层面就支持并发和并行
- Go并发小案例

```go
package main

import (
    "fmt"
    "time"
)

func sing()  {
    for i:=0; i< 10; i++{
        fmt.Println("我在唱歌")
        time.Sleep(time.Millisecond)
    }
}
func dance() {
    for i:=0; i< 10; i++{
        fmt.Println("我在跳舞---")
        time.Sleep(time.Millisecond)
    }
}

func main() {
    // 串行: 必须先唱完歌才能跳舞
    //sing()
    //dance()

    // 并行: 可以边唱歌, 边跳舞
    // 注意点: 主线程不能死, 否则程序就退出了
    go sing() // 开启一个协程
    go dance() // 开启一个协程
    for{
        ;
    }
}
```

+ runtime包中常用的函数

  + Gosched:使当前go程放弃处理器，以让其它go程运行

  ```go
  package main
  import (
      "fmt"
      "runtime"
  )
  
  func sing()  {
      for i:=0; i< 10; i++{
          fmt.Println("我在唱歌")
          // Gosched使当前go程放弃处理器，以让其它go程运行。
          // 它不会挂起当前go程，因此当前go程未来会恢复执行
          runtime.Gosched()
      }
  }
  func dance() {
      for i:=0; i< 10; i++{
          fmt.Println("我在跳舞---")
          runtime.Gosched()
      }
  }
  
  func main() {
  
      go sing()
      go dance()
      for{
          ;
      }
  }
  ```

  + Goexit: 终止调用它的go程, 其它go程不会受影响

  ```go
  package main
  import (
      "fmt"
      "runtime"
  )
  
  func main() {
      go func() {
          fmt.Println("123")
          // 退出当前协程
          //runtime.Goexit()
          // 退出当前函数
          //return
          test()
          fmt.Println("456")
      }()
      for{
          ;
      }
  }
  
  func test()  {
      fmt.Println("abc")
      // 只会结束当前函数, 协程中的其它代码会继续执行
      //return
      // 会结束整个协程, Goexit之后整个协程中的其它代码不会执行
      runtime.Goexit()
      fmt.Println("def")
  }
  ```

  + NumCPU: 返回本地机器的逻辑CPU个数

  ```go
  package main
  import (
      "fmt"
      "runtime"
  )
  func main() {
      num := runtime.NumCPU()
      fmt.Println(num)
  }
  ```

  + GOMAXPROCS: 设置可同时执行的最大CPU数，并返回先前的设置

    + Go语言1.8之前, 需要我们手动设置
    + Go语言1.8之后, 不需要我们手动设置

    ```go
     func main() {
          // 获取带来了CPU个数
          num := runtime.NumCPU()
          // 设置同时使用CPU个数
          runtime.GOMAXPROCS(num)
      }
    ```


[iOS多线程](https://juejin.im/post/5a30fcfbf265da4321540a46)

[关于iOS多线程](https://www.jianshu.com/p/186f5cdbf4a4)